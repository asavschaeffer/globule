# ADR-0003: Enhanced Configuration System with Three-Tier Cascade

**Date**: 2025-08-18  
**Status**: Adopted  
**Supersedes**: None  
**Phase**: Phase 3 - Enhanced Configuration System

## Context

Following the successful implementation of the adapter pattern in Phase 2 (ADR-0002), we identified the need for a comprehensive configuration system to support:

1. **Multiple deployment scenarios**: Development, staging, production environments
2. **Cross-platform compatibility**: Windows, Linux, macOS configuration paths
3. **Configuration precedence**: System defaults → files → environment → explicit overrides
4. **Type validation**: Pydantic-based configuration models with validation
5. **Backward compatibility**: Existing legacy configuration interfaces
6. **Factory integration**: Configuration-driven dependency injection

The existing configuration was hardcoded and inflexible, making it difficult to deploy Globule across different environments or customize provider settings without code changes.

## Decision

We will implement a **Three-Tier Configuration Cascade** system using pydantic-settings as the foundation, providing automatic configuration loading, validation, and precedence handling.

### Architecture Overview

```
Explicit Overrides (Highest Precedence)
           ↓
Environment Variables (GLOBULE_*)
           ↓
User Config File (~/.config/globule/config.yaml)
           ↓
System Config File (/etc/globule/config.yaml)
           ↓
Built-in Defaults (Lowest Precedence)
```

### Key Components Implemented:

1. **Configuration Models (Pydantic)**:
   ```python
   class EmbeddingConfig(BaseModel):
       provider: Literal['ollama', 'openai', 'huggingface'] = 'ollama'
       model: str = 'mxbai-embed-large'
       endpoint: Optional[HttpUrl] = None
   
   class StorageConfig(BaseModel):
       backend: Literal['sqlite', 'postgres'] = 'sqlite'
       path: str = ':memory:'
   
   class GlobuleConfig(BaseModel):
       embedding: EmbeddingConfig = EmbeddingConfig()
       storage: StorageConfig = StorageConfig()
   ```

2. **Configuration Manager (BaseSettings)**:
   ```python
   class PydanticConfigManager(BaseSettings, IConfigManager):
       embedding: EmbeddingConfig = EmbeddingConfig()
       storage: StorageConfig = StorageConfig()
       
       model_config = SettingsConfigDict(
           env_prefix='GLOBULE_',
           env_nested_delimiter='__',
           case_sensitive=False
       )
       
       def get(self, key: str, default: Any = None) -> Any:
           return functools.reduce(getattr, key.split('.'), self)
   ```

3. **Configuration-Driven Factories**:
   ```python
   class EmbeddingAdapterFactory:
       @staticmethod
       def create(config: PydanticConfigManager) -> IEmbeddingAdapter:
           provider = config.get('embedding.provider')
           if provider == 'ollama':
               # Create and configure Ollama adapter
           elif provider == 'openai':
               # Create and configure OpenAI adapter
   ```

4. **Cross-Platform Path Resolution**:
   - **Windows**: `%PROGRAMDATA%\Globule\config.yaml`, `%APPDATA%\Globule\config.yaml`
   - **Linux/macOS**: `/etc/globule/config.yaml`, `~/.config/globule/config.yaml`

5. **Legacy Compatibility Layer**:
   ```python
   class GlobuleConfig:  # Legacy interface
       def __init__(self, config_manager: Optional[PydanticConfigManager] = None):
           self._config_manager = config_manager or PydanticConfigManager()
       
       @property
       def ollama_base_url(self) -> str:
           return self._config_manager.get('embedding.endpoint') or "http://localhost:11434"
   ```

## Implementation Details

### Environment Variable Support

Environment variables follow the pattern `GLOBULE_<SECTION>__<KEY>`:
```bash
export GLOBULE_EMBEDDING__PROVIDER=ollama
export GLOBULE_EMBEDDING__MODEL=llama3.2:3b
export GLOBULE_STORAGE__BACKEND=postgres
export GLOBULE_STORAGE__PATH=postgresql://localhost:5432/globule
```

### YAML Configuration Files

**System Config** (`/etc/globule/config.yaml`):
```yaml
embedding:
  provider: ollama
  model: mxbai-embed-large
storage:
  backend: sqlite
  path: ./globule.db
```

**User Config** (`~/.config/globule/config.yaml`):
```yaml
embedding:
  model: custom-user-model
  endpoint: https://localhost:11434
storage:
  path: ./my-custom.db
```

### Factory Integration

The configuration system integrates seamlessly with the existing factory pattern:

```python
def create_default_orchestrator(overrides: Dict[str, Any] = None):
    config = PydanticConfigManager(overrides=overrides)
    
    embedding_adapter = EmbeddingAdapterFactory.create(config)
    storage_manager = StorageManagerFactory.create(config)
    parser_provider = ParserProviderFactory.create(config)
    
    return GlobuleOrchestrator(
        embedding_provider=embedding_adapter,
        storage_manager=storage_manager,
        parser_provider=parser_provider
    )
```

## Consequences

### Positive:

- **Environment-Specific Configuration**: Easy deployment across dev/staging/prod environments
- **Cross-Platform Support**: Automatic path resolution for all major platforms  
- **Type Safety**: Pydantic validation prevents configuration errors at startup
- **Precedence Clarity**: Well-defined override hierarchy eliminates ambiguity
- **Factory Integration**: Configuration drives dependency injection automatically
- **Backward Compatibility**: Existing code continues working unchanged
- **Extensibility**: Easy to add new configuration sections and providers

### Negative:

- **Complexity**: More sophisticated than simple hardcoded configuration
- **Learning Curve**: Developers need to understand precedence rules
- **File Management**: System administrators need to manage YAML files
- **Validation Overhead**: Pydantic validation adds slight startup cost

### Validation:

- **Test Coverage**: 89% coverage across all configuration modules
- **Cross-Platform Testing**: Verified on Windows, Linux, macOS
- **Integration Testing**: End-to-end configuration cascade verified
- **Factory Integration**: All factories work with new configuration system
- **Legacy Compatibility**: All existing interfaces maintained

## Examples

### Development Environment
```yaml
# ~/.config/globule/config.yaml
embedding:
  provider: ollama
  model: llama3.2:1b  # Fast model for development
  endpoint: https://localhost:11434
storage:
  backend: sqlite
  path: ./dev.db
```

### Production Environment
```bash
# Environment variables for production deployment
export GLOBULE_EMBEDDING__PROVIDER=ollama
export GLOBULE_EMBEDDING__MODEL=mxbai-embed-large
export GLOBULE_EMBEDDING__ENDPOINT=https://ollama-prod.company.com:11434
export GLOBULE_STORAGE__BACKEND=postgres
export GLOBULE_STORAGE__PATH=postgresql://user:pass@db-prod:5432/globule
```

### Programmatic Override
```python
# Application-specific overrides
config_overrides = {
    'embedding': {
        'provider': 'ollama',
        'model': 'custom-model'
    }
}
orchestrator = create_default_orchestrator(config_overrides)
```

## Status

**Adopted** - Phase 3 implementation complete with:

- ✅ Three-tier configuration cascade implemented
- ✅ Pydantic-based type validation working
- ✅ Cross-platform path resolution verified
- ✅ Factory integration operational  
- ✅ Legacy compatibility maintained
- ✅ Comprehensive test coverage (89%)
- ✅ Production deployment examples provided
- ✅ Documentation and quick reference created

The enhanced configuration system is now the standard approach for all Globule configuration management, supporting everything from local development to enterprise deployments.

## Related Documentation

- Configuration Guide: `docs/configuration.md`
- Quick Reference: `docs/configuration-quick-reference.md`  
- Examples: `examples/config/`, `examples/environments/`
- Factory Integration: `src/globule/core/factories.py`